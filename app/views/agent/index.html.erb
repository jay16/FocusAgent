<div class="span10 offset1">

   <div class="row">

	<!--worker------------------------------------------------------------>				    
	  <%
            resque  = Resque
	    workers = resque.working
	    jobs = workers.collect {|w| w.job }
	    worker_jobs = workers.zip(jobs)                       
	    worker_jobs = worker_jobs.reject { |w, j| w.idle? }       
	  %>                                                              

	  <h4><%= worker_jobs.size %> of <%= resque.workers.size %> Workers Working</h4>

	  <table class='table table-bordered table-striped'>
	    <thead>
	      <tr>                                                                          
		<th>&nbsp;</th>
		<th>Where</th>                                                                    
		<th>Queue</th>                                                                            
		<th>Processing</th>
	      </tr>                                                                                               
	    </thead>

	    <tbody>

	      <% if worker_jobs.empty? %>
	      <tr>
		<td colspan="4" style="text-align:center;">Nothing is happening right now...</td>
	      </tr>                                                                                                                         
	      <% end %>

	      <% worker_jobs.sort_by {|w, j| j['run_at'] ? j['run_at'] : '' }.each do |worker, job| %>                                                      
		<tr>
		  <td class='icon'><img src="<%=u state = worker.state %>.png" alt="<%= state %>" title="<%= state %>"></td>                                          
		  <% host, pid, queues = worker.to_s.split(':') %>
		  <td class='where'><a href="<%=u "/workers/#{worker}" %>"><%= host %>:<%= pid %></a></td>
		  <td class='queues queue'>
		    <a class="queue-tag" href="<%=u "/queues/#{job['queue']}" %>"><%= job['queue'] %></a>                                                                                </td>
		  <td class='process'>
		    <% if job['queue'] %>
			<code><%= job['payload']['class'] %></code>
			<small><a class="queue time" href="<%=u "/working/#{worker}" %>"><%= job['run_at'] %></a></small>
		      <% else %>
			<span class='waiting' style="text-align:center">Waiting for a job...</span>
		      <% end %>
		    </td>
		  </tr>
		<% end %>
	     </tbody>
	   </table>

     </div>
   <div class="row">
      <h4>SendMail</h4>
      <table class="table table-striped table-bordered">
	 <thead>
	    <tr>
	      <% %w(index 域名  时速(封) ETH Valid/ALL WaitMails NeedTime Worker Klass RunAt).each do |dd| %>
		<td><%= dd %></td>
	      <% end %>
	    </tr>
	 </thead>
	 <tbody>
	    <% wait_mails = chkMail %>
	    <% workers = Resque.workers %>
	    <% sendMailStates.each do |sm| %>
	    <tr>
		 <td><%= sm[0] + 1 %></td>
		 <td><%= sm[1] %></td>
		 <td><%= sm[2] %></td>
		 <td><%= sm[3] %></td>
		 <td> 
		     <% eth_valids = getEthValids(sm[1]) %>
		     <%= eth_valids[0] ? 'unkown' : eth_valids[1].size %>/16
		 </td>
		 <td><% wait_mail = wait_mails[sm[0]].to_i %>
		     <%= wait_mail %> 
		 </td>
		 <td>
                     <% mins = wait_mail ? 60* wait_mail/sm[2].to_i/eth_valids[1].size : 0 %>
		     <%= "#{mins/60}h #{mins%60}m" %>
                 </td>
		 <td><% worker = workers.select { |w| w.processing["queue"] ==  sm[4]} %>
		     <% data = worker.size > 0 ? worker[0].processing : {} %>
		     <%= worker.size %>
		 </td>
		 <td><%= data["queue"] ? data["payload"]["class"] : nil %></td>
		 <td><%= data["queue"] ? Time.parse(data["run_at"]).strftime("%y/%m/%d %H:%M:%S") : nil %></td>
		
	    </tr>
	       <% end %>
	 </tbody>
      </table>
   </div>

  <div class="row">
    <h4>Mail Mqueue Wait Status</h4>

    <table class="table table-bordered table-striped">
      <thead>
	<tr>
	  <th>wait</th>
	  <th colspan="16" style="text-align:center;">port</th>
	</tr>

	<tr>
	  <th>eth</th>
	 <% (0..15).each do |port| %>
	  <th><%= port %></th>
	 <% end %>
	</tr>
      </thead>

      <tbody>
	<% wait_status = getMqueueWaitStatus %>
	<% %w(163 126 sina qq).each do |eth|%>
	 <tr>
	  <td><%= eth %></td>
	  <% (0..15).each do |port| %>
	       <td><%= wait_status.fetch(eth)[port] %></td>
	  <% end %>
	 </tr>
	<% end %>
      </tbody>

    </table>
  </div>
   
  </div>
